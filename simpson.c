#include <math.h>
#include "simpson.h"

/* Интеграл функции f на [a,b] с точностью eps
 * (итеративная формула Симпсона без кэша) */
double integral(double (*f)(double), double a, double b, double eps)
{
    /* начальное разбиение: n = 2 отрезка, h = (b-a)/2 */
    unsigned n = 2;
    double h  = (b - a) / n;

    /* S   – текущее значение интеграла Симпсона
       S4  – сумма f(x_чёт)  (= f(a)+f(b)   пока не меняется)
       S2  – сумма f(x_нечёт)= f(a+h)+f(a+3h)+... – обновляется инкрементно */
    double S4 = f(a) + f(b);
    double S2 = f(a + h);
    double S  = (h / 3.0) * (S4 + 4.0 * S2);

    for (;;)
    {
        /* удваиваем число отрезков */
        n   <<= 1;          /* n *= 2 */
        h   /=  2.0;

        /* добавляем значения функции в новых серединах:
           x = a + h, a + 3h, … , b - h  (всего n/2 новых точек) */
        double sum_new = 0.0;
        for (unsigned k = 1; k < n; k += 2)
            sum_new += f(a + k * h);

        /* новая «нечётная» сумма – старая S2 + sum_new;
           старая S2 становится «чётной» частью (теперь коэффициент 2)   */
        S2 += sum_new;
        S4 += 2.0 * sum_new;        /* потому что в формуле Симпсона эти точки
                                       превращаются в чётные при следующем шаге */

        double S_new = (h / 3.0) * (S4 + 4.0 * S2);

        if (fabs(S_new - S) < 15.0 * eps)
            return S_new;

        S = S_new;
    }
}
